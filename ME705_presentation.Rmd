---
title: "Modelos de Regressão Linear Mistos para dados discretos: Uma abordagem utilizando MCMC através do Stan integrado ao R"
author: 
  - Felipe Vieira - RA 160424
  - Guilherme Artoni - RA 160318
output: 
  beamer_presentation:
    theme: "Singapore"
    colortheme: "seagull"
    fonttheme: "structurebold"
header-includes:
  - \usepackage[utf8]{inputenc}
  - \usepackage[brazil, english, portuguese]{babel}
  - \usepackage[utf8]{inputenc}
  - \usepackage[T1]{fontenc}
  - \usepackage[fixlanguage]{babelbib}
  - \usepackage{times}

  - \usepackage{graphicx}
  - \usepackage{wrapfig}
  - \usepackage{pdfpages}
  
  - \usepackage{amsfonts}
  - \usepackage{amssymb}
  - \usepackage{amsmath}
  
  - \usepackage{fancyhdr}
  - \usepackage{subcaption}
  - \usepackage{booktabs}
  - \usepackage{caption}
  - \usepackage{float}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE,
                      warning = FALSE,error = FALSE,
                      fig.align = "center",
                      fig.width = 4,
                      fig.height = 3)
options(knitr.table.format = "latex")
```

Degeneração macular relacionada à idade (DMRI)
========================================================

- É uma doença atualmente sem cura;
- Leva a perda progressiva da visão central;
- Visão turva é o principal sintoma;
- É muito comum em pessoas com mais de 55 anos.

Dados
========================================================

- Grupo de Estudo de Terapias Farmacológicas para Degeneração Macular;
- O objetivo é avaliar se um novo medicamento para DMRI tem poder competitivo com o principal existente no mercado;
- Ensaios clínicos aleatorizados;
- Realizados em diferentes centros de estudos;
- 240 pacientes;
- Foi medida a  qualidade da visão de todos os pacientes no início e após 4, 12, 24 e 52 semanas.

Análise Descritiva
========================================================

```{r perfis,echo = FALSE, warning=FALSE,message=FALSE,fig.cap="Gráfico de perifs de alguns indivíduos selecionados aleatoriamente", fig.align = "center"}
library(nlme)
library(nlmeU)
library(lattice)
library(rstanarm)
library(rstan)
library(tidyverse)
library(kableExtra)

# Gera os gráficos de perfis
data(armd.wide, armd0, package = "nlmeU")
armd0.subset <- subset(armd0, as.numeric(subject) %in% seq(1, 240, 10))
xy1 <- xyplot(visual ~ jitter(time) | treat.f,
              groups = subject,
              data = armd0.subset,
              type = "l", lty = 1)
update(xy1, xlab = "Tempo (em semanas)", ylab = "Qualidade da visão", grid = "h")
```

Análise Descritiva
========================================================

```{r resumo,echo = FALSE,warning=FALSE,message=FALSE}
# Gera a tabela do número de observações em cada semana
attach(armd0)
flst <- list(time.f, treat.f)
tN <- tapply(visual, flst, FUN = function(x) length(x[!is.na(x)]))

# Médias e medianas amostrais das medidas da qualidade da visão para cada semana observada
tMn <- tapply(visual, flst, FUN = mean)
tMd <- tapply(visual, flst, FUN = median)
#colnames(res <- cbind(tN, tMn, tMd))
res <- cbind(tN, round(tMn,2), tMd)

nms1 <- rep(c("P", "A"), 3)
nms2 <- rep(c("n", "Média", "Mediana"), rep(2,3))
colnames(res) <- paste(nms1, nms2, sep = ":")
rownames(res) <- c("Início", "4smn", "12smn", "24smn", "52smn")

kable(res, align = "c", 
      caption = "Número de observações, médias e medianas de cada semana obervada.") %>%
  kable_styling(latex_options = "HOLD_position",
                font_size = 8) %>% 
  kable_styling(latex_options = "scale_down")
```

Análise Descritiva
========================================================

```{r boxplot,echo = FALSE,warning=FALSE,message=FALSE,fig.cap="Boxplots das medidas de qualidade da visão de cada tempo observado.", fig.align = "center"}
# Gera os boxplots
bw1 <- bwplot(visual ~ time.f | treat.f, data = armd0)
xlims <- c("Base", "4\nsmn", "12\nsmn", "24\nsmn", "52\nsmn")
update(bw1, xlim = xlims, pch = "|")
```

 Análise Descritiva
========================================================

* **Matriz de Variâncias e Covariâncias**

```{r varcov_sample,echo = FALSE,warning=FALSE,message=FALSE}
# Calcula as matrizes de variâncias e covariâncias e de correlações amostrais
visual.x <- subset(armd.wide, select = c(visual0:visual52))
varx <- var(visual.x, use = "complete.obs")
rownames(varx) <- c("Início", "4smn", "12smn", "24smn", "52smn")
colnames(varx) <- c("Início", "4smn", "12smn", "24smn", "52smn")
round(varx,2)
```

 Análise Descritiva
========================================================

*  **Matriz de Correlações**

```{r corr_sample,echo = FALSE,warning=FALSE,message=FALSE}
corr <- round(cor(visual.x, use = "complete.obs"),2)
rownames(corr) <- c("Início", "4smn", "12smn", "24smn", "52smn")
colnames(corr) <- c("Início", "4smn", "12smn", "24smn", "52smn")
corr
```

Modelo Misto
========================================================

$$\boldsymbol{Y}_{j(k_{j} \ \text{x} \ 1)} = \boldsymbol{X}_{j(k_{j} \ \text{x} \ p)}\boldsymbol{\beta}_{(p \ \text{x} \ 1)} + \boldsymbol{Z}_{j(k_{j} \ \text{x} \ q)}\boldsymbol{b}_{j(q \ \text{x} \ 1)}+\boldsymbol{\xi}_{j(k_{j} \ \text{x} \ 1)}$$
Onde j = 1,2,...,n é o individuo

* $\boldsymbol{Y}_{j} = (y_{j1},...,y_{jk_{j}})$: vetor resposta, no qual $k_{j}$ é o número de avaliações realizadas no individuo j.
* $\boldsymbol{X}_{j}$: matriz de planejamento associada aos efeitos fixos para o indivíduo j.
* $\boldsymbol{\beta}$: vetor de efeitos fixos
* $\boldsymbol{Z}_{j}$: matriz de planejamento associada aos efeitos aleatórios para o indivíduo j.
* $\boldsymbol{b}_{j}$: vetor de efeitos aleatórios associado ao indivíduo j.
* $\boldsymbol{\xi}_{j}$: vetor de erros associado ao indivíduo j.

Modelo Proposto
========================================================

$$Y_{it} = \beta _0 + \beta _1 x_{1i} + \beta _2 x_{2it} + \beta _3 x_{3i} + \beta _4 x_{2it} x_{3i} + b_{0i} + \xi _{it},$$

* $Y_{it}$ é a qualidade da visão do paciente i (i = 1, ..., 240) no tempo t (t = 1, 2, 3, 4, correspondendo aos valores 4º, 12º, 24º e 52º semana, respectivamente);
* $x_{1i}$ é o valor inicial da qualidade da visão;
* $x_{2it}$ é o tempo t de medição no paciente i;
* $x_{3i}$ é o indicador do tratamento, 0 se placebo e 1 caso contrário;
* $x_{2it} x_{3i}$ é a interação entre as duas covariáveis.

Modelo Proposto
========================================================

$$Y_{it} = \beta _0 + \beta _1 x_{1i} + \beta _2 x_{2it} + \beta _3 x_{3i} + \beta _4 x_{2it} x_{3i} + b_{0i} + \xi _{it},$$

* $\beta _0$ é o intercepto geral;
* $\beta _1$ é o incremento positivo ou negativo no valor esperado de $Y_{it}$ quando variado em uma unidade o valor inicial da qualidade da visão;
* $\beta _2$ é o incremento positivo ou negativo na valor esperado de $Y_{it}$, quando acrescido o tempo em uma semana entre as que foram observadas;
* $\beta _3$ é o efeito geral positivo ou negativo no valor esperado de $Y_{it}$ causado pelo tratamento;
* $\beta _4$ é o incremento positivo ou negativo sobre o valor esperado de $Y_{it}$, gerado pela variação do tempo em uma semana entre as que foram observadas sobre o paciente i que estava sob tratamento.

Modelo Proposto
========================================================

$$Y_{it} = \beta _0 + \beta _1 x_{1i} + \beta _2 x_{2it} + \beta _3 x_{3i} + \beta _4 x_{2it} x_{3i} + b_{0i} + \xi _{it},$$

* $b_{0i}$ é o efeito aleatório específico para cada paciente. Tal que $b_{0i} \overset{\small{iid}}{\sim} \cal{N}(\text{0}, \ \tau) \ \forall$ i;
* $\xi _{it}$ é o erro aleatório. Tal que  $\xi _{it} \overset{\small{iid}}{\sim} \cal{N}(\text{0}, \ \sigma ^\text{2}) \ \forall$ i e t;
* $b_{0i}$ representa uma variação especifica do $\beta _0$ para cada paciente.

Modelo Proposto
========================================================

* Forma matricial do modelo para o indivíduo i  

$$
\begin{pmatrix}
Y_{i1} \\
Y_{i2} \\
Y_{i3} \\
Y_{i4} \\
\end{pmatrix} 
=  
\begin{pmatrix}
1 & x_{1i} & 4 & x_{3i} & 4x_{3i}\\ 
1 & x_{1i} & 12 & x_{3i} & 12x_{3i}\\
1 & x_{1i} & 24 & x_{3i} & 24x_{3i}\\
1 & x_{1i} & 52 & x_{3i} & 52x_{3i}\\
\end{pmatrix}
\begin{pmatrix}
\beta_0 \\
\beta_1 \\
\beta_2 \\
\beta_3 \\
\beta_4 \\
\end{pmatrix} +
\begin{pmatrix}
1 \\
1 \\
1 \\
1 \\
\end{pmatrix} b_{0t}
+ \begin{pmatrix}
\xi_{i1} \\
\xi_{i2} \\
\xi_{i3} \\
\xi_{i4} \\
\end{pmatrix}
$$

Modelo Proposto
========================================================

* Estrutura Uniforme da matriz de Variâncias e Covariâncias

$$
\begin{pmatrix}
\sigma^{{2}} + \tau & \tau & \tau & \tau \\
\tau & \sigma^{{2}} + \tau & \tau & \tau \\
\tau & \tau & \sigma^{{2}} + \tau & \tau \\
\tau & \tau & \tau & \sigma^{{2}} + \tau
\end{pmatrix}
$$

Inferência
========================================================

**Cadeias de Markov** (CM)

* Sequência de variáveis aleatórias discretas  
* Espaço de estados denotado por S=$\{s_1,s_2,\dots,s_k\}$

Se vale ,
$$p(X_t | X_{t-1},X_{t-2},\dots,X_{0})=p(X_t | X_{t-1}),$$
para t$=1,2,\dots,$ a sequência de variáveis aleatórias é uma CM.

A probabilidade que o processo mude de $X_{t} = s_i$ para $X_{t+1} = s_j$ é dada pela matriz de transição, $P=\{p_{ij}\}$.  
A restrição natural sobre a matriz de transição é que a soma das linhas seja 1, $\sum_j p_{ij} = 1$, para todo $i$.  
Uma CM admite uma distribuição de equilíbrio $\boldsymbol{\pi}$ se existir $\boldsymbol{\pi}$ tal que $\boldsymbol{\pi} = \boldsymbol{\pi} P$.

Inferência
========================================================

* **Irredutibilidade**

Uma CM, cujas as variáveis aleatórias são discretas, é dita irredutível se for uma cadeia em que partindo-se de um estado qualquer, pode-se atingir qualquer estado, inclusive o inicial, em um número finito de transições.

* **Reversibilidade**

Uma CM é dita reversível se a probabilidade de estar em um estado $s_i$ e mover-se para $s_j$ é igual à probabilidade de estar no estado $s_j$ e mover-se para o estado $s_i$, ou seja,
$$\boldsymbol{\pi}(i)p(i,j) = \boldsymbol{\pi}(j)p(j,i)$$
A reversibilidade de uma CM está associada ao fato da mesma admitir uma distribuição de equilíbrio.

Inferência
========================================================

* **Amostrador de Gibbs**

O Amostrador de Gibbs (AG) é um método para aproximar uma distribuição multivariada tomando somente amostras de distribuições univariadas.

Suponha que a distribuição a posteriori tenha função de densidade $\pi(\theta_1, \theta_2, \dots,\theta_p)$ para os $p$ parâmetros $\theta_1, \theta_2, \dots,\theta_p$ e seja $\pi(\theta_i | \theta_1, \dots, \theta_{i-1}, \theta_{i+1}, \dots,\theta_p)$ a função densidade condicional para $\theta_i$ dado os valores dos outros parâmetros.

Inferência
========================================================

* **Amostrador de Gibbs**

Tomando arbitrariamente valores iniciais $\{\theta_1(0), \theta_2(0), \dots,\theta_p(0)\}$ para os $p$ parâmetros e em seguida mudá-los um a um selecionando novos valores como segue:
$$\theta_1(1) \quad \text{é escolhido de} \quad \pi(\theta_1 | \theta_2(0), \theta_3(0), \dots,\theta_p(0))$$
$$\theta_2(1) \quad \text{é escolhido de} \quad \pi(\theta_2 | \theta_1(1), \theta_3(0), \dots,\theta_p(0))$$
$$\theta_3(1) \quad \text{é escolhido de} \quad \pi(\theta_3 | \theta_1(1), \theta_2(1), \theta_4(0) \dots,\theta_p(0))$$
$$\vdots$$
$$\theta_p(1) \quad \text{é escolhido de} \quad \pi(\theta_p | \theta_1(1), \theta_2(1), \dots,\theta_{p-1}(1))$$

Inferência
========================================================

* **Metropolis - Hastings**

Deve-se construir um núcleo de transição $p(\theta,\phi)$ de forma que $\pi$ seja a distribuição de equilíbrio da cadeia. Uma forma simples de fazer isso é através de cadeias onde o núcleo $p$ satisfaça 
$$\pi(\theta)p(\theta,\phi) = \pi(\phi)p(\phi,\theta), \quad \forall \quad (\theta,\phi)$$
Embora não seja necessária, ela é suficiente para que $\pi$ seja a distribuição de equilíbrio da cadeia.

Inferência
========================================================

* **Metropolis - Hastings**

O núcleo $p(\theta,\phi)$ é constituído de 2 elementos: um núcleo de transição arbitrário $q(\theta,\phi)$ e uma probabilidade $\alpha(\theta,\phi)$ de forma que,
$$p(\theta,\phi) = q(\theta,\phi)\alpha(\theta,\phi), \quad \text{se} \quad \theta \ne \phi$$
Portanto, o núcleo de transição define uma densidade $p(\theta, .)$ para todos os valores diferentes de $\theta$. Consequentemente, resta uma probabilidade positiva da cadeia ficar em $\theta$ dada por
$$p(\theta,\theta) = 1 - \int q(\theta,\phi)\alpha(\theta,\phi)\text{d}\phi$$
A expressão mais comum para a probabilidade de aceitação é 
$$\alpha(\theta,\phi) = min\{1,\frac{\pi(\phi)\text{q}(\phi,\theta)}{\pi(\theta)\text{q}(\theta,\phi)}\}$$

Inferência
========================================================

* **Metropolis - Hastings**

Em termos práticos a simulação de uma amostra de $\pi$ usando a CM:

i) inicialize o contador de iterações da cadeia $j = 1$ e tome um valor arbitrário para $\theta{(0)}$;

ii) mova a cadeia para um novo valor $\phi$ gerado da densidade $q(\theta{(j-1)},.)$ ;

iii) calcule a probabilidade de aceitação do movimento $\alpha(\theta{(j-1)},\phi)$ . Se o movimento for aceito, $\theta{(j)} = \phi$, caso contrário $\theta{(j)} = \theta{(j-1)}$ e a cadeia não se move;

iv) mude o contador de $j$ para $j+1$ e retorne ao item ii) até a convergência.

Inferência
========================================================

* **Metropolis - Hastings**

A etapa iii) é realizada após a geração de uma quantidade uniforme $u \sim U(0,1)$ independente de todas as outras variáveis. Se $u \le \alpha$, o movimento é aceito e se $u > \alpha$ o movimento não é permitido.

Inferência
========================================================

* **Metropolis-within-Gibbs**

O AG pode ser visto como um caso particular do Metropolis-Hastings (MH) onde as distribuições geradoras de candidatos são as condicionais da distribuição de interesse e o candidato é aceito com probabilidade 1.

Considere a situação em que para um vetor aleatório com K elementos, sendo que alguns deles tem densidades condicionais bem definidas e fáceis de gerar, enquanto que os demais não tem esta  facilidade. 

Neste caso podemos fazer uso combinado do AG para as variáveis fáceis de gerar e do MH para as demais.

Resultados
========================================================

```{r include=FALSE}
# MAKE DESIGN MATRIX
X <- unname(model.matrix(~1+visual0+time+treat.f+treat.f:time,armd))
attr(X,"assign") <- NULL
Z <- matrix(1,nrow = nrow(X),ncol=1)

# MAKE STAN DATA
stanDat <- list(N = nrow(X),
                P = ncol(X),
                nr = ncol(Z),
                X = X,
                Z = Z,
                Time = nlevels(armd$time.f),
                M = nlevels(armd$treat.f),
                I = nlevels(armd$subject),
                patient = as.integer(armd$subject),
                visual = as.integer(armd$visual),
                visual0 = as.integer(armd$visual0),
                time = as.integer(armd$time.f),
                treat = as.integer(armd$treat.f))

# FIT THE MODEL
matrixFit <- stan(file = "matrixModel.stan",
                  data=stanDat,
                  iter = 2000, chains = 4)
```

```{r}
estimate_table <- round(summary(matrixFit,pars = c("beta","sigma_e","sigma_p"))$summary,2)
colnames(estimate_table)[1:3] <- c("Média", "DP da média", "DP")
```

```{r}
kable(estimate_table,
      align = "c",
      caption = "Resultados do ajuste do modelo.") %>%
  kable_styling(latex_options = "HOLD_position",
                font_size = 8) %>% 
  kable_styling(latex_options = "scale_down")
```

Resultados
========================================================

```{r}
D <- diag(round(sqrt(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2)),2),nrow = 4)
S <- matrix(round(estimate_table["sigma_p","Média"]**2,2),ncol = 4,nrow = 4)
diag(S) <- round(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2),2)
Dinv <- solve(D)
corr_mtrx <- round(Dinv%*%S%*%Dinv,2)
```

**Estimativa da Matriz de Variâncias e Covariâncias Condicionais:**

$$
\begin{pmatrix}
`r round(estimate_table["sigma_e","Média"]**2,2)` & 0 & 0 & 0 \\
0 & `r round(estimate_table["sigma_e","Média"]**2,2)` & 0 & 0 \\
0 & 0 & `r round(estimate_table["sigma_e","Média"]**2,2)` & 0 \\
0 & 0 & 0 & `r round(estimate_table["sigma_e","Média"]**2,2)` \\
\end{pmatrix}
$$

Resultados
========================================================

**Estimativa da Matriz de Variâncias e Covariâncias Marginais:**

$$
\begin{pmatrix}
`r round(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2),2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` \\
`r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2),2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` \\
`r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2),2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` \\
`r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(estimate_table["sigma_p","Média"]**2,2)` & `r round(sum(estimate_table[c("sigma_e","sigma_p"),"Média"]**2),2)` \\
\end{pmatrix}
$$

Resultados
========================================================

**Estimativa da Matriz de Correlações:**

$$
\begin{pmatrix}
`r corr_mtrx[1,1]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` \\
`r corr_mtrx[1,2]` & `r corr_mtrx[1,1]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` \\
`r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,1]` & `r corr_mtrx[1,2]` \\
`r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,2]` & `r corr_mtrx[1,1]` \\
\end{pmatrix}
$$

Resultados
========================================================

```{r warmup, fig.cap="Gráfico mostrando o resultado sobre convergência da CM, após descartado o warm-up.", fig.pos="H"}
traceplot(matrixFit,pars=c("sigma_p"))
```

Considerações Finais
========================================================

* A partir da análise descritiva e ajuste do modelo verificamos que os pacientes perderam parte da acuidade visual durante o tempo do experimento o que vai de acordo com a característica da doença;

* Essa perda foi mais grave entre os pacientes que estavam sob o tratamento do *interferon*$-\alpha$;

* Podemos ver que a metodologia de inferência proposta se adequou a estrutura do modelo, visto que obtivemos a convergência das sequência de forma consistente.
